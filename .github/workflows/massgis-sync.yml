name: MassGIS Data Sync

on:
  schedule:
    # Run at 00:00 on the 10th of January and July (buffer after Jan 1/Jul 1 releases)
    - cron: '0 0 10 1,7 *'
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find Download URL
        id: find_url
        run: |
          # Fetch page and extract the specific S3 URL for the shapefile aggregate
          # Looking for pattern like: .../L3_AGGREGATE_SHP_YYYYMMDD.zip
          
          PAGE_CONTENT=$(curl -sL https://www.mass.gov/info-details/massgis-data-property-tax-parcels)
          
          # Grep for the URL. 
          # We use a pattern that matches the known S3 structure for the SHP zip.
          DOWNLOAD_URL=$(echo "$PAGE_CONTENT" | grep -o 'https://[^"]*L3_AGGREGATE_SHP_[0-9]*.zip' | head -n 1)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "::error::Could not find download URL on MassGIS page."
            exit 1
          fi
          
          echo "Found URL: $DOWNLOAD_URL"
          echo "url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          
          # Extract Date ID (e.g., 20250101) from filename
          FILENAME=$(basename "$DOWNLOAD_URL")
          DATE_ID=$(echo "$FILENAME" | grep -o '[0-9]\{8\}')
          
          echo "Date ID: $DATE_ID"
          echo "date_id=$DATE_ID" >> $GITHUB_OUTPUT

      - name: Check for Existing Release
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: "data-${{ steps.find_url.outputs.date_id }}"
        run: |
          if gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "Release $TAG_NAME already exists. Skipping sync."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG_NAME does not exist. Proceeding."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Download, Split and Release
        if: steps.check_release.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          URL: ${{ steps.find_url.outputs.url }}
          DATE_ID: ${{ steps.find_url.outputs.date_id }}
          TAG_NAME: "data-${{ steps.find_url.outputs.date_id }}"
        run: |
          echo "Starting download and split process for $URL..."
          
          # Create a directory for chunks
          mkdir -p chunks
          
          # Stream download directly into split
          # -b 1900M -> Split into ~1.9GB chunks (GitHub limit is 2GB)
          # numeric suffixes (-d)
          curl -L "$URL" | split -b 1900M - "chunks/massgis-parcels-${DATE_ID}-part-" -d
          
          # Rename chunks to add .zip extension for clarity (optional, but helps OS identify them somewhat)
          # Actually, raw parts are better combined with 'cat'. Let's keep them simple.
          
          echo "Chunks created:"
          ls -lh chunks/
          
          # Create Release
          echo "Creating GitHub Release $TAG_NAME..."
          gh release create "$TAG_NAME" \
            --title "MassGIS Parcels $DATE_ID" \
            --notes "Automated sync of Massachusetts Statewide Property Tax Parcels from MassGIS. Source: $URL" \
            --draft=false \
            --prerelease=false
            
          # Upload Assets
          echo "Uploading chunks..."
          for file in chunks/*; do
             echo "Uploading $file..."
             gh release upload "$TAG_NAME" "$file" --clobber
          done
          
          echo "Sync Complete!"
